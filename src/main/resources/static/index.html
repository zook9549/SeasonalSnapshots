<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>View Snapshots</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script src="/scripts/jquery-min.js"></script>
    <script src="/scripts/jquery-ui.min.js"></script>
    <link href="./styles/jquery-ui.css" rel="stylesheet"/>
    <link href="/styles/bootstrap.min.css" rel="stylesheet"/>
    <script src="/scripts/bootstrap.min.js"></script>

    <script>
        Date.prototype.yyyymmdd = function (yearAdjustment) {
            var year = this.getFullYear();
            if (yearAdjustment) {
                year += yearAdjustment;
            }
            var yyyy = year.toString();
            var mm = (this.getMonth() + 1).toString(); // getMonth() is zero-based
            var dd = this.getDate().toString();
            return (mm[1] ? mm : "0" + mm[0]) + "/" + (dd[1] ? dd : "0" + dd[0]) + "/" + yyyy;
        };
        var imgs = [];
        var counter = 0;
        var imgDates = [];
        var to;
        var mod = true;
        var timing = 1000;
        d = new Date();
        $(document).ready(function () {
            getCameras();
            $("#frmApp")[0].startDate.value = d.yyyymmdd(-1);
            $("#frmApp")[0].endDate.value = d.yyyymmdd();
            $("#startDate").datepicker();
            $("#endDate").datepicker();
            $('button#submitButton').click(function (e) {
                e.preventDefault();
                var camera = $("#frmApp")[0].cameraKey.value;
                if(camera) {
                    var url = '/getSnapshotPaths?camera=' + camera + "&start=" +
                        $("#frmApp")[0].startDate.value + "&end=" + $("#frmApp")[0].endDate.value;
                    if ($("#frmApp")[0].sunrise.checked) {
                        url += "&phase=" + $("#frmApp")[0].sunrise.value;
                    }
                    if ($("#frmApp")[0].solarNoon.checked) {
                        url += "&phase=" + $("#frmApp")[0].solarNoon.value;
                    }
                    if ($("#frmApp")[0].sunset.checked) {
                        url += "&phase=" + $("#frmApp")[0].sunset.value;
                    }
                    imgs = [];
                    counter = 0;
                    if (to) {
                        to = clearTimeout(to);
                    }
                    $.ajax({
                        url: url,
                        method: "GET",
                        dataType: 'json',
                        processData: false,
                        contentType: false,
                        success: function (data) {
                            for (var i = 0; i < data.length; i++) {
                                if (i == 0) {
                                    $("#holder").html("<img id=\"snapshot1\" src=\"" + data[i].archivePath + "\">" +
                                        "<img id=\"snapshot2\" src=\"" + data[i].archivePath + "\">" +
                                        "<div id=\"snapshotCaption\">1" + " / " + data.length + " : " + data[i].snapshotTime + "</div>\n");
                                }
                                var img = new Image();
                                img.src = data[i].archivePath;
                                img.alt = data[i].snapshotTime;
                                imgs[i] = img;
                                imgDates[i] = data[i].snapshotTime;
                            }
                            console.log(imgs);
                            if (imgs.length > 1) {
                                to = setTimeout(slideShow, timing);
                            }
                        },
                        error: function (er) {
                            $("#errorAlert").fadeIn(500).fadeOut(2000);
                        }
                    });
                } else {
                    console.log("No camera selected")
                }
            });
        });

        function slideShow() {
            var topEl = getSlideShowImage(true);
            var bottomEl = getSlideShowImage(false);
            if (counter < imgs.length - 1) {
                counter++;
            } else {
                counter = 0;
            }
            mod = !mod;
            bottomEl.hide();
            bottomEl.attr("src", imgs[counter].src);
            $("#snapshotCaption").html((counter + 1) + " / " + imgs.length + " : " + imgs[counter].alt);
            bottomZIndex = bottomEl.css('z-index')
            bottomEl.css('z-index', topEl.css('z-index'));
            topEl.css('z-index', bottomZIndex);
            bottomEl.toggle("fade", 800);
            to = setTimeout(slideShow, timing);
        }

        function getCameras() {
            $.getJSON("/getCameras", function (data) {
                for (var i = 0; i < data.length; i++) {
                    $('#cameraKey')
                        .append($("<option></option>")
                            .attr("value", data[i].name)
                            .text(data[i].name));
                }

            });
        }

        function getSlideShowImage(isVisible) {
            if ($("#snapshot1").css('z-index') > $("#snapshot2").css('z-index')) {
                return isVisible ? $("#snapshot1") : $("#snapshot2");
            } else {
                return isVisible ? $("#snapshot2") : $("#snapshot1");
                ;
            }
        }

        function toggleSlideShow() {
            getSlideShowImage(true).effect("pulsate")
            if (to) {
                to = clearTimeout(to);
            } else {
                to = setTimeout(slideShow, timing);
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet"/>
    <link href="/styles/snapshots.css" rel="stylesheet"/>
</head>
<body>
<form id="frmApp" role="form" method="post" action="/addApp">
    <div id="addApp">
        <div class="form-group">
            <div id="cameraContainer" class="input-group input-group-lg">
                <label for="cameraKey" class="sr-only">Camera</label>
                <span class="input-group-addon" id="basic-addon3">Camera</span>
                <select class="custom-select form-control" id="cameraKey">
                </select>
            </div>
            <div id="startContainer" class="input-group input-group-lg">
                <label for="startDate" class="sr-only">Start Date</label>
                <span class="input-group-addon" id="basic-addon">Start Date</span>
                <input type="text" name="start" id="startDate"
                       placeholder="Start Date MM/DD/YYYY"
                       class="form-control"/>
            </div>
            <div id="endContainer" class="input-group input-group-lg">
                <label for="endDate" class="sr-only">End Date</label>
                <span class="input-group-addon" id="basic-addon2">End Date</span>
                <input type="text" name="appName" id="endDate"
                       placeholder="End Date MM/DD/YYYY"
                       class="form-control"/>
            </div>
            <div class="input-group input-group-lg form-check">
                <label class="input-group-addon form-check-label" for="sunrise">
                    Sunrise
                </label>
                <input class="form-check-input form-control" type="checkbox" value="SUNRISE" id="sunrise"
                       style="width:100px;">
            </div>
            <div class="input-group input-group-lg form-check">
                <label class="input-group-addon form-check-label" for="solarNoon">
                    Solar Noon
                </label>
                <input class="form-check-input form-control" type="checkbox" value="SOLAR_NOON" id="solarNoon"
                       style="width:100px;">
            </div>
            <div class="input-group input-group-lg form-check">
                <label class="input-group-addon form-check-label" for="sunset">
                    Sunset
                </label>
                <input class="form-check-input form-control" type="checkbox" value="SUNSET" id="sunset"
                       style="width:100px;">
            </div>
            <div class="btnContainer text-center">
                <button class="btn btn-lg btn-primary btn-block" value="Save App" id="submitButton">View Snapshots
                </button>
            </div>
        </div>
    </div>
</form>
<div class='slideshow-container' onclick="toggleSlideShow();" id="holder">
</div>
</body>
</html>